---
title: "diversity analyses with brm/full data set etc."
---

```{r pkgs}
source("mmd_utils.R")
source("gamm4_utils.R")
L <- load("ecoreg.RData")
library(broom.mixed)
library(stringr)
library(dplyr)
library(brms)
library(corrplot)
library(dplyr)
library(ggplot2); theme_set(theme_bw())
```


## getting brms to run (original data set)

`brms` (actually the underlying `Stan` platform may complain about "divergent steps". There is quite a bit of discussion about how to fix this, e.g. [brms github issues](https://github.com/paul-buerkner/brms/issues/128), but it seems that using `adapt_delta=0.99` takes care of problems that we have.

from `?set_prior`:

- default prior on SDs is half-Student with 3 df, scale parameter based on std dev of response (>=10) e.g. `set_prior("<prior>", class="sd", group="<group>")` (is this going to regularize enough??)
- default correlation priors `lkj_(eta)`: `eta=1` - flat; `eta > 1` extreme correlations less likely

Looks like the default priors might be OK.

## basic results

```{r}
L <- load("allfits_sum_gamm4.RData") ## 4 taxa x 27 fits, using gamm4
L <- load("allfits_sum_brms.RData")
gamm4_coefs <- (
    gamm4_res$coef
    ## take just best model
    %>% inner_join(filter(gamm4_res$sum,best),by=c("taxon","model"))
    %>% select(-c(AIC,singular,df,best)))
unique(brms_res$coefs$term)
unique(gamm4_coefs$term)
brms_res$coefs <- (brms_res$coefs
    %>% mutate(term=str_replace(term,"Intercept","(Intercept)"))
    %>% mutate(term=str_replace(term,"logarea_km2","log(area_km2)"))
    %>% filter(!grepl("^.?Intercept.?$",term))
    %>% mutate(cat=case_when(grepl("^cor",term) ~ "cor",
                             grepl("^sd",term) ~ "sd",
                             TRUE ~ "fixed"),
               ## reorder
               cat=factor(cat,levels=c("fixed","sd","cor")))
    ## reorder term by estimate *within* categories -- fussy ...
    %>% arrange(cat,estimate)
    %>% mutate(term=factor(term,levels=unique(term)))
)
ggplot(brms_res$coefs,aes(estimate,term,colour=taxon))+
    ggstance::geom_pointrangeh(aes(xmin=conf.low,xmax=conf.high))+
    facet_wrap(~cat,scale="free",ncol=1)+
    geom_vline(xintercept=0,lty=2)
```

```{r}
comb <- bind_rows(brms=brms_res$coefs,gamm4=gamm4_coefs,
                  .id="platform")
comb_fixed <- comb %>% filter(effect=="fixed") %>%
    mutate(term=reorder(term,estimate))
ggplot(comb_fixed,aes(estimate,term,colour=platform))+
    ggstance::geom_pointrangeh(aes(xmin=conf.low,xmax=conf.high))+
    facet_wrap(~taxon,scale="free")+
    geom_vline(xintercept=0,lty=2)
```
What do we conclude?

```{r}
vv <- VarCorr(b1)
## vv$biome$cor[,"Estimate",]
## vv$biome$cor[,"Est.Error",]
```

## Markov random field stuff

- `corsar(W, type=c("lag","error"))`; "lag" = SAR on response values; "error" = SAR on residuals
- [CrossValidated](https://stats.stackexchange.com/questions/277/spatial-statistics-models-car-vs-sar)
     - non-spatial: "My House Value is a function of my home Gardening Investment"
     - SAR: "My House Value is a function of the House Values of my neighbours."
     - CAR: "My House Value is a function of the Gardening Investment of my neighbours"
	 - [issue describing mrf smooth](https://github.com/paul-buerkner/brms/issues/128)
	 - `?mgcv::mrf`: can give polygons (`polys`), or neighborhood structure (`nb`)

