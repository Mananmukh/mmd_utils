---
title: "Final (?) figures"
author: "Enric Batllori and Ben Bolker"
date: "`r Sys.time()`"
output: 
  html_document:
    toc: yes
    code_folding: hide
---

## Code and package dependencies

![](make_figs.png)

Data in google drive (linked to `googledrive` ...

```{r get_utils,warning=FALSE,message=FALSE}
source("utils.R")
source("gamm4_utils.R")
do_maps <- TRUE ## skip map drawing sometimes (slow!)
```

```{r load_packages,message=FALSE,warning=FALSE}
load_all_pkgs()
graphics_setup()
source("palettes.R")
library('pander')  ## for tables
sapply(pkgList,function(x) format(packageVersion(x)))
```

```{r knitr_setup,echo=FALSE,warning=FALSE}
library(knitr)
opts_chunk$set(error=FALSE)
```

Load data and model results
```{r source_files, warning = FALSE}
best_models <- readRDS("bestmodels_gamm4.rds")
ecoreg <- readRDS("ecoreg.rds")
load('full_data_LAND.RData')
data_dir <- "bigdata"
## might need allfits_sum_gamm4.rds too, for profile CIs?
```

```{r load_full_data}
L <- load("full_data.RData")
```

Additional data (includes area and lat/long coordinates)

```{r get_data, eval=do_maps, warning=FALSE, cache=TRUE}
# full data set (only working variables) - to use in Figure 3
## slow
load(file=file.path(data_dir, "FireDiversityDataset_20170504.RData")) # full data set with all the original vars, including fraction burned
# computing mean values per ecoregion -- ONLY land masses
db.land <- db[land == 1,]	# selecting only land masses
db.land$fracburn <- round(db.land$tBA_mean/db.land$AREA.cell,4)	# computing "mean" fraction of area burned per cell (as opposed to burned area)
setkey(db.land, eco_id)    # sorting the data set by ecoregion id
db.land <- as.data.frame(db.land)
biomes <- readOGR(file.path(data_dir, 'wwf_terr_ecos'), verbose = FALSE)
land_limits <- readOGR(file.path(data_dir, 'WORLD_Limits_LAND'), verbose = FALSE)
# changing the coordinate reference system
biomes <- spTransform(biomes, CRS = CRS("+proj=eck4 +lon_0=0 +x_0=0 +y_0=0 +a=6371000 +b=6371000 +units=m +no_defs"))
# ecoreg-level means
bb <- ddply(db.land,.(eco_id), summarise, biome = unique(biomes), fracburn = mean(fracburn, na.rm=TRUE))
# biome-level means
bm <- ddply(bb,.(biome),summarise, fracburn = mean(fracburn, na.rm = TRUE))
read_fun <- function(x) {
    read.csv(x,
             quote="'",
             stringsAsFactors=FALSE,
             strip.white=TRUE,
             comment="#",
             ## treat 'NA' in abbrevs (Nearctic='NA') as a real value!
             na.strings="")
}

biome_defs <- read_fun("biome_defs.csv")
fbdat <- full_join(bm, biome_defs, by = c("biome"="code")) %>% dplyr::select(abbrev, fracburn) %>% rename(biome=abbrev)
```
  
Computing combined indices of mean and CV for NPP and Feat. A 3-level classification of each variable is used; breakpoints = quantile c(0,0.35,0.7,1).

```{r combined_data,eval=do_maps, warning=FALSE}
#  defining levels of NPP_log and NPP_cv_sc      				
nlev <- 3	  
brk_npp_comb <- seq(min(ecoreg$NPP_log,na.rm=TRUE),max(ecoreg$NPP_log,na.rm=TRUE),length=nlev+1)	  
brk_nppcv_comb <- seq(min(ecoreg$NPP_cv_sc,na.rm=TRUE),max(ecoreg$NPP_cv_sc,na.rm=TRUE),length=nlev+1)	
## trying quantiles instead ... 	  
brk_npp_comb <- quantile(ecoreg$NPP_log,na.rm=TRUE,c(0,0.35,0.7,1)) 
brk_nppcv_comb <- quantile(ecoreg$NPP_cv_sc,na.rm=TRUE,c(0,0.35,0.7,1))	
# "classifying" NPP_log and NPP_cv_sc into 10 classes
npp_comb_class <- findInterval(ecoreg$NPP_log,brk_npp_comb,all.inside=F,rightmost.closed=TRUE)	
nppcv_comb_class <- findInterval(ecoreg$NPP_cv_sc,brk_nppcv_comb,all.inside=F,rightmost.closed=TRUE)
# composite NPP-NPP_cv classes, e.g. "1 1",... "3 4", ... bb <- bio_to_plot
npp_code = paste(npp_comb_class,nppcv_comb_class)											
# possible levels of composite NPP-NPP_cv
# npp_lev = paste(rep(c(1:nlev),each=nlev),c(1:nlev))						
npp_lev <- rev(paste(rep(c(1:nlev),each=nlev),c(nlev:1)))
ll <- 1
for(l in npp_lev){ npp_code[which(npp_code[] == l)] <- ll; ll <- ll+1 }	# replacing classes byn a numeric code, e.g. 1,...16,...
npp_code <- as.numeric(npp_code)	  

# defining levels of Feat_log and Feat_cv_sc													
nlev = 3	  
brk_feat_comb <- seq(min(ecoreg$Feat_log,na.rm=TRUE),max(ecoreg$Feat_log,na.rm=TRUE),length=nlev+1)	  
brk_featcv_comb <- seq(min(ecoreg$Feat_cv_sc,na.rm=TRUE),max(ecoreg$Feat_cv_sc,na.rm=TRUE),length=nlev+1)	
## trying quantiles instead... 
brk_feat_comb <- quantile(ecoreg$Feat_log,na.rm=TRUE,c(0,0.35,0.7,1))	  
brk_featcv_comb <- quantile(ecoreg$Feat_cv_sc,na.rm=TRUE,c(0,0.35,0.7,1))	
# "classifying" NPP_log and NPP_cv_sc into 10 classes
feat_comb_class <- findInterval(ecoreg$Feat_log,brk_feat_comb,all.inside=F,rightmost.closed=TRUE)	
featcv_comb_class <- findInterval(ecoreg$Feat_cv_sc,brk_featcv_comb,all.inside=F,rightmost.closed=TRUE)
# composite NPP-NPP_cv classes, e.g. "1 1",... "3 4", ... 
feat_code = paste(feat_comb_class,featcv_comb_class)											
# possible levels of composite NPP-NPP_cv
# npp_lev = paste(rep(c(1:nlev),each=nlev),c(1:nlev))						
feat_lev <- rev(paste(rep(c(1:nlev),each=nlev),c(nlev:1)))
ll <- 1
for(l in feat_lev){ feat_code[which(feat_code[] == l)] <- ll; ll <- ll+1 }	# replacing classes byn a numeric code, e.g. 1,...16,...
feat_code <- as.numeric(feat_code)	  
													
# adding npp_code and feat_code to ecoreg
ecoreg$NPP_code <- npp_code
ecoreg$Feat_code <- feat_code
# changing colnames of ecoreg to match 'ECO_ID' in the biomes shapefile
colnames(ecoreg)[1] <- 'ECO_ID'
# joining biomes@data with ecoreg
bio_to_plot <- biomes
bio_to_plot <- spTransform(bio_to_plot, CRS = CRS("+proj=eck4 +lon_0=0 +x_0=0 +y_0=0 +a=6371000 +b=6371000 +units=m +no_defs"))
bio_to_plot@data <- join(bio_to_plot@data,ecoreg,by='ECO_ID')
```

## Framework (maps, NPP, biodiversity, etc...)

### Figure 1

Basic maps of realms, biomes, ecoregions, biodiversity, and NPP and Feat indices of joint mean and CV.

```{r map_plot}
map_plot <- function(x, x_orig, title = "", cex.title = 1.6, leg.digits = 0) {
  brk <- seq(min(x,na.rm=TRUE), max(x,na.rm=TRUE), length=101)
  x_class <- as.numeric(findInterval(x, brk, all.inside=FALSE, rightmost.closed=TRUE))
  x_class <- data.frame(ECO_ID = ecoreg$ECO_ID, x_class)
  bio_to_plot@data <- join(bio_to_plot@data, x_class, by='ECO_ID')
  par(mar=c(0,0,0,0),mgp=c(0,-2,0),tck=0)
  plot(bio_to_plot, col=pal_div(100)[bio_to_plot$x_class], border=NA)
  mkborders()
  mktitle(title, cex.axis = cex.title)
  ## legend
  par(bty='n'); llab <- round(range(x_orig, na.rm=TRUE), digits = leg.digits)
  image.plot(legend.only=TRUE, smallplot=c(0.08,0.15,0.3,0.42), zlim=c(brk[1],brk[101]),
             col=pal_div(100), axis.args=list(cex.axis=0.9,
                                              at=c(brk[1], brk[101]),
                                              lab=c(llab[1], llab[2]),mgp=c(0,0.3,0)))
}
```

```{r maps,fig.width=10,fig.height=8, echo=FALSE, eval=do_maps, cache = TRUE}
### Realms, Biomes, Ecoregions + Diversity -----------------------------------------------------
library(fields)
# to plot only biomes/floristic realms for the ecoregions included in land masses (bigger than Australia)
biom_plot <- bio_to_plot[which(!is.na(bio_to_plot$x)),]

# tiff('D:/Enric/8.Fire_Biodiversity/4.Mixed_Effects_Nov2019/Fig_1.tif',height=3500,width=3500,res=350,compression='lzw')

## can't use ggsave here
png("fig1.png", width=12, height = 8, units = "in", res=300)
# plot layout
m_layout <- layout(matrix(1:9, ncol=3, byrow=TRUE))
mktitle   <- function(lab, cex.axis = 1.6) axis(side=3, at=0, lab=lab, tck=0, lty=0, cex.axis=cex.axis, font=2)
mkborders <- function() plot(land_limits, add=TRUE, col=NA, border='grey50', lwd=0.5)

par(mar=c(0,0,0,0), mgp=c(0,-2,0), tck=0)
plot(biom_plot,
     col=pal_realm[factor(biom_plot$REALM)], border=NA)
mkborders()
mktitle("Realms")

# color breaks
brk = seq(0.5,16.5,by=1)	
par(mar=c(0,0,0,0),mgp=c(0,-2,0),tck=0)
plot(biom_plot, col=pal_biome[factor(biom_plot$BIOME)], border=NA)
mkborders()
mktitle("Biomes")

brk <- c(sort(unique(biom_plot$ECO_ID))-0.5,max(biom_plot$ECO_ID,na.rm=TRUE)+0.5)
set.seed(15091979) ## random sample of colors
par(mar=c(0,0,0,0),mgp=c(0,-2,0),tck=0)
plot(biom_plot, col=pal_ecoreg(length(brk-1))[sample(1:length(brk-1))],border=NA) #[findInterval(biom_plot$ECO_ID,brk,all.inside=F,rightmost.closed=TRUE)],border=NA)
mkborders()
mktitle("Ecoregions")

## Birds richness

## brk <- seq(min(ecoreg$mbirds_log,na.rm=TRUE),max(ecoreg$mbirds_log,na.rm=TRUE),length=101)
## birds_class <- as.numeric(findInterval(ecoreg$mbirds_log, brk, all.inside=FALSE, rightmost.closed=TRUE))
## birds_class <- as.data.frame(cbind(ECO_ID = ecoreg$ECO_ID,birds_class = birds_class))
## bio_to_plot@data <- join(bio_to_plot@data,birds_class,by='ECO_ID')
## par(mar=c(0,0,0,0))
## plot(bio_to_plot,col=pal_div(100)[bio_to_plot$birds_class],border=NA)
## mkborders()
## mktitle('Bird richness')
## ## add legend
## par(bty='n'); llab <- round(range(ecoreg$mbirds,na.rm=TRUE))
## image.plot(legend.only=TRUE,smallplot=c(0.08,0.15,0.3,0.42),zlim=c(brk[1],brk[101]),col=pal_div(100),
##            axis.args=list(cex.axis=0.9, at=c(brk[1],brk[101]),lab=c(llab[1],llab[2]),mgp=c(0,0.3,0)))
map_plot(ecoreg$mbirds_log, ecoreg$mbirds, "Bird richness")

# Mammal richness
## brk <- seq(min(ecoreg$mmamm_log,na.rm=TRUE),max(ecoreg$mmamm_log,na.rm=TRUE),length=101)
## mamm_class <- as.numeric(findInterval(ecoreg$mmamm_log,brk,all.inside=F,rightmost.closed=TRUE))
## mamm_class <- as.data.frame(cbind(ECO_ID = ecoreg$ECO_ID,mamm_class = mamm_class))
## bio_to_plot@data <- join(bio_to_plot@data,mamm_class,by='ECO_ID')
## par(mar=c(0,0,0,0))
## plot(bio_to_plot,col=pal_div(100)[bio_to_plot$mamm_class],border=NA)
## mkborders()
## mktitle("Mammal richness")
## ## legend
## par(bty='n'); llab <- round(range(ecoreg$mmamm,na.rm=TRUE))
## image.plot(legend.only=TRUE,smallplot=c(0.08,0.15,0.3,0.42),zlim=c(brk[1],brk[101]),
##            col=pal_div(100),axis.args=list(cex.axis=0.9, at=c(brk[1],brk[101]),lab=c(llab[1],llab[2]),mgp=c(0,0.3,0)))

map_plot(ecoreg$mmamm_log, ecoreg$mmamm, "Mammal richness")

# Amphibian richness
## brk <- seq(min(ecoreg$mamph_log,na.rm=TRUE),max(ecoreg$mamph_log,na.rm=TRUE),length=101)
## amph_class <- as.numeric(findInterval(ecoreg$mamph_log,brk,all.inside=F,rightmost.closed=TRUE))
## amph_class <- as.data.frame(cbind(ECO_ID = ecoreg$ECO_ID,amph_class = amph_class))
## bio_to_plot@data <- join(bio_to_plot@data,amph_class,by='ECO_ID')
## par(mar=c(0,0,0,0))
## plot(bio_to_plot,col=pal_div(100)[bio_to_plot$amph_class],border=NA)
## mkborders()
## mktitle("Amphibian richness")
## ## legend
## par(bty='n'); llab <- round(range(ecoreg$mamph,na.rm=TRUE))
## image.plot(legend.only=TRUE,smallplot=c(0.08,0.15,0.3,0.42),zlim=c(brk[1],brk[101]),
##            col=pal_div(100),axis.args=list(cex.axis=0.9, at=c(brk[1],brk[101]),lab=c(llab[1],llab[2]),mgp=c(0,0.3,0)))

map_plot(ecoreg$mamph_log, ecoreg$mamph, "Amphibian richness")

# Ecoregion area
brk <- seq(min(log(ecoreg$area_km2+1),na.rm=TRUE),max(log(ecoreg$area_km2+1),na.rm=TRUE),length=101)
area_class <- as.numeric(findInterval(log(ecoreg$area_km2+1),brk,all.inside=F,rightmost.closed=TRUE))
area_class <- as.data.frame(cbind(ECO_ID = ecoreg$ECO_ID,area_class = area_class))
bio_to_plot@data <- join(bio_to_plot@data,area_class,by='ECO_ID')
par(mar=c(0,0,0,0))
plot(bio_to_plot,col=pal_area(100)[bio_to_plot$area_class],border=NA)
mkborders()
mktitle("Ecoregion area")
par(bty='n')
image.plot(legend.only=TRUE,smallplot=c(0.08,0.15,0.3,0.42),zlim=c(brk[1],brk[101]),col=pal_area(100),axis.args=list(cex.axis=1.1, at=c(brk[1],brk[101]),lab=c('small','large')))

# NPP - NPP_cv plot
r <- raster(nrow=3,ncol=3,xmn=0,xmx=4,ymn=0,ymx=4)
r <- setValues(r,1:9)
par(mar=c(0,0,0,0),mgp=c(0,-2,0),tck=0)
plot(bio_to_plot,col=pal_py[bio_to_plot$NPP_code],border=pal_py[bio_to_plot$NPP_code])
mkborders()
mktitle("NPP")
par(new=TRUE,plt=c(0.1,0.22,0.2,0.35),mgp=c(0,0.2,0),bty='n')
image(r,col=pal_py,breaks=seq(0.5,9.5,by=1),axes=FALSE,xlab='',ylab='')
axis(side=2,at=c(0,3.5),lab=c('l_NPP\nl_CV','h_NPP\nl_CV'),las=2,cex.axis=0.9,lty=0)
axis(side=4,at=c(0,3.5),lab=c('l_NPP\nh_CV','h_NPP\nh_CV'),las=2,cex.axis=0.9,lty=0)

# Feat - Feat_cv plot
par(mar=c(0,0,0,0),mgp=c(0,-2,0),tck=0)
plot(bio_to_plot,col=pal_br[bio_to_plot$Feat_code],border=pal_br[bio_to_plot$Feat_code])
mkborders()
mktitle("Fire consumption")
par(new=TRUE,plt=c(0.1,0.2,0.2,0.35),mgp=c(0,0.2,0),bty='n')
image(r,col=pal_br,breaks=seq(0.5,9.5,by=1),axes=FALSE,xlab='',ylab='')
axis(side=2,at=c(0,3.5),lab=c('l_Fcons\nl_CV','h_Fcons\nl_CV'),las=2,cex.axis=0.9,lty=0)
axis(side=4,at=c(0,3.5),lab=c('l_Fcons\nh_CV','h_Fcons\nh_CV'),las=2,cex.axis=0.9,lty=0)
invisible(dev.off())  ## fig1.png
```

![](fig1.png)

### Extra figs for supp (NPP Mean/CV, Fire consumption mean/cv)

```{r supp_maps, cache=TRUE}
png("fig1_supp.png", width=8, height = 5.333, units = "in", res=300)
# plot layout
m_layout <- layout(matrix(1:4, ncol=2, byrow=TRUE))
map_plot(ecoreg$NPP_log_sc, ecoreg$NPP_mean, "NPP (mean)")
map_plot(ecoreg$NPP_cv_sc, ecoreg$NPP_cv_inter, "NPP (variability)", leg.digits = 1)
map_plot(ecoreg$Feat_log_sc, ecoreg$Feat_mean, "Fire consumption (mean)", leg.digits = 1)
map_plot(ecoreg$Feat_cv_sc, ecoreg$Feat_cv_inter, "Fire consumption (variability)", leg.digits = 1)
invisible(dev.off()) ## fig1_supp.png
```

![](fig1_supp.png)

### Figure 2

Summary of NPP (green) and proportion of NPP eaten by fire (red) at the biome level. Diversity of amphibians, birds and mammals for each biome is also shown. Diversity data (number of species at 10km pixels) comes from Jenkins et al. (2013) PNAS, doi: 10.1073/pnas.1302251110. 

```{r old_barplot, echo=FALSE, eval=FALSE}
## biome_means <- ddply(ecoreg,.(biome),summarise,
##                      NPP = mean(NPP_mean,na.rm=TRUE),
##                      NPP_cv = mean(NPP_cv_inter,na.rm=TRUE),
##                      Feat = mean(Feat_mean, na.rm=TRUE),
##                      Feat_cv = mean(Feat_cv_inter,na.rm=TRUE),
##                      amph=mean(mamph,na.rm=TRUE),
##                      birds=mean(mbirds,na.rm=TRUE),
##                      mamm=mean(mmamm,na.rm=TRUE))
## biome_means$FNPP <- biome_means$NPP*biome_means$Feat

trans_names <- function(x) {
  gsub("^m","m",
       gsub("(_mean|_inter)","",x))
}
biome_means <- (ecoreg 
  %>% group_by(biome)
  %>% summarise_at(c("NPP_mean","NPP_cv_inter",
                     "Feat_mean","Feat_cv_inter",
                     "mamph","mbirds","mmamm"),
                   ~mean(.,na.rm=TRUE))
  %>% setNames(trans_names(names(.)))
  %>% mutate(FNPP=NPP*Feat)
)

# option 2 - computing FNPP at the ecoreg level and then computing biome means -- probably more correct?
full_data$FNPP <- full_data$NPP_mean*full_data$Feat_mean
bb <- ddply(full_data,.(eco_id),summarise, biome = unique(biome), area = sum(AREA_cell), NPP = mean(NPP_mean,na.rm=TRUE), NPP_cv = mean(NPP_cv_inter,na.rm=TRUE), Feat = mean(Feat_mean, na.rm=TRUE), Feat_median = median(Feat_mean, na.rm=TRUE), Feat_cv = mean(Feat_cv_inter,na.rm=TRUE), FNPP = mean(FNPP, na.rm=TRUE), amph=mean(amph,na.rm=TRUE), birds=mean(birds,na.rm=TRUE), mamm=mean(mamm,na.rm=TRUE))
# removing data with no biome assigned... 
bb <- bb[-(which(is.na(bb$biome))),]

bm <- ddply(bb,.(biome),summarise, NPP = mean(NPP,na.rm=TRUE), NPP_cv = mean(NPP_cv,na.rm=TRUE), Feat = mean(Feat, na.rm=TRUE), Feat_cv = mean(Feat_cv,na.rm=TRUE), FNPP = mean(FNPP, na.rm=TRUE), amph=mean(amph,na.rm=TRUE), birds=mean(birds,na.rm=TRUE), mamm=mean(mamm,na.rm=TRUE))

# sorting the data set by NPP levels
biome_means <- biome_means[order(biome_means$NPP),]
bm <- bm[order(bm$NPP),]

# scaled variables !! scaling is done together for NPP and FNPP -- patterns are the same than for raw data
bm$NPP_sc <- scale(c(bm$NPP,bm$FNPP))[1:14]
bm$NPP_sc2 <- bm$NPP_sc + abs(min(scale(c(bm$NPP,bm$FNPP))))
bm$FNPP_sc <- scale(c(bm$NPP,bm$FNPP))[15:28]
bm$FNPP_sc2 <- bm$FNPP_sc + abs(min(scale(c(bm$NPP,bm$FNPP))))
# log variables
bm$NPP_log <- log(bm$NPP)
bm$FNPP_log <- log(bm$FNPP)

biome_name <- c('TrMF','TrDF','TrCF','TeBF','TeCF','BorF','TrG','TeG','FlG','MoG','Tund','MedF','Des','Mang','Lak','R&I')
bm$biomeshort <- bm$biome
levels(bm$biomeshort) <- biome_name

## "RAW" values plot
# NPP barplot
par(plt=c(0.08,0.38,0.15,0.9),mgp=c(1.7,0.6,0))
bp <- barplot(bm$NPP,horiz=TRUE,beside=F,col=c('darkolivegreen3'),border=NA,names.arg=bm$biomeshort,las=2,main = 'NPP',xlab='g C / m2 * year',xaxt='n')
axis(side=1, tck=-0.015)
# Feat plot (fraction of NPP eaten by fire, as %)
par(new=TRUE,plt=c(0.40,0.55,0.15,0.9), mgp=c(1.7,0.6,0))
bp <- barplot(round(bm$Feat * 100,2),horiz=TRUE,beside=F,col=c('orangered'),border=NA,las=2,main = 'Fire loss',xlab='% of NPP',xaxt='n')
axis(side=1, tck=-0.015)
# Amph
par(new=TRUE,plt=c(0.57,0.68,0.15,0.9))
bp <- barplot(bm$amph,horiz=TRUE,beside=F,col=c('grey80'),border=NA,las=2, xlim=c(0,50),main='Amph',xlab='',xaxt='n')
axis(side=1,at=seq(0,50,by=25),lab=seq(0,50,by=25), tck=-0.015)
# Birds
par(new=TRUE,plt=c(0.71,0.82,0.15,0.9))
bp <- barplot(bm$birds,horiz=TRUE,beside=F,col=c('grey60'),border=NA,las=2, xlim=c(0,400),main='Birds',xlab='N species / 10km^2',xaxt='n')
axis(side=1,at=seq(0,400,by=100),lab=seq(0,400,by=100), tck=-0.015)
# Mamm
par(new=TRUE,plt=c(0.85,0.96,0.15,0.9))
bp <- barplot(bm$mamm,horiz=TRUE,beside=F,col=c('grey40'),border=NA,las=2, xlim=c(0,150),main='Mamm',xlab='',xaxt='n')
axis(side=1,at=seq(0,150,by=50),lab=seq(0,150,by=50), tck=-0.015)
```

```{r barplots}
## (ecoreg
##   %>% group_by(biome)
##   %>% summarise(across(area_km2, ~sum(.)/1e6))
##   %>% dplyr::select(biome, area_km2)
##   %>% arrange(area_km2)
## )

shortnames <- data.frame(biome = c("Trop/Subtrop Moist", "Trop/Subtrop Dry", "Trop/Subtrop Conif",
                                   "Temp Broad", "Temp Conif", "Boreal/Taiga", "Trop Grass", "Temp Grass",
                                   "Flood Grass", "Mont Grass", "Tundra", "Medit", "Desert/Shrub", 
                                   "Mangro"),
                         bshort = c('TrMF', 'TrDF', 'TrCF',
                                    'TeBF', 'TeCF', 'BorF', 'TrG', 'TeG',
                                    'FlG', 'MoG', 'Tund', 'MedF', 'Des', 'Mang'))

e_mean <- (ecoreg
  %>% full_join(shortnames, by = "biome")
  %>% group_by(bshort, biome)
  %>% mutate(across(area_km2, ~ sum(.) / 1e6))## set area to **sum** of area (millions of km^2)
  %>% summarise(across(c(NPP_mean, Feat_mean, mamph, mbirds, mmamm, area_km2), mean, na.rm = TRUE), .groups="drop")
  %>% mutate(across(bshort, ~ reorder(factor(.), NPP_mean)))
  %>% mutate(across(Feat_mean, ~ . * 100)) ## convert to pct
  %>% arrange(desc(bshort))
)

## https://stackoverflow.com/questions/56025382/ggrepel-labels-outside-to-the-right-of-ggplot-area/56027661#56027661
## https://stackoverflow.com/questions/12409960/ggplot2-annotate-outside-of-plot
## compute positions for area-stacked chart
## 

## 
inter <- 0.75 ## inter-bar spacing
e_mean2 <- (e_mean
  %>% arrange(bshort)
  ## calculations for bar spacing
  %>%  mutate(tot_area = cumsum(area_km2+inter),
              prev_area = c(0, tot_area[1:n()-1]),
              mid = (prev_area+tot_area)/2,
              ymin = prev_area + inter/2,
              ymax = tot_area - inter/2,
              area2 = ymax-ymin)
)
stopifnot(all.equal(e_mean2$area2,e_mean2$area_km2))
## e_mean2 %>% dplyr::select(biome, area_km2, tot_area, prev_area, mid, ymin, ymax, area2)

## bshort = c('TrMF', 'TrDF', 'TrCF',
##            'TeBF', 'TeCF', 'BorF', 'TrG', 'TeG',
##           'FlG', 'MoG', 'Tund', 'MedF', 'Des', 'Mang'))

lab_nudge_y <- with(e_mean2,setNames(rep(0, length(bshort)), bshort))
lab_nudge_y[c("TrCF", "Mang", "FlG")] <- 2*c(0.5, -0.5, 0.2)

library(ggrepel)
mkplot <- function(var, colour, type = "rect", xlab = "", title= "") {
  g1 <- ggplot(e_mean2)
  if (type == "rect") {
    g1 <- g1 + geom_rect(xmin = 0, aes(xmax = {{var}}, ymin = ymin, ymax = ymax),
                         fill = colour) +
      ## geom_text_repel(x = -1,
      ##                 aes(label = bshort, y = mid), 
      ##                 direction = "y",
      ##                 ## VERY close. TrMF, TeBF are below where I want them
      ##                 hjust = 0,
      ##                 vjust = 0,
      ##                 segment.size = 0.2,
      ##                 na.rm = TRUE,
      ##                 force_pull = 100,
      ##                 force = 0.5,
      ##                 min.segment.length = 0.5,
      ##                 xlim = c(-2, 0)) +
      geom_text(x = -20, hjust = 1,
                aes(label = bshort, y = mid + lab_nudge_y)) +
      coord_cartesian(clip = 'off') +
      theme(plot.margin = margin(t=5.5, r=1, b=5.5, l=50, unit="pt")) +
      ## theme(axis.text.y = element_text(size=7)) ## try to avoid overlapping labels ( + 'inter')
      theme(axis.text.y = element_blank()) ## try to avoid overlapping labels ( + 'inter')
      ylabs <- e_mean2$bshort  ## short names
  } else {
    g1 <- g1 + geom_point(aes(x={{var}}, y = mid), colour = colour, size=3) +
      geom_segment(x=0, aes(xend = {{var}}, y = mid, yend = mid), colour = colour, linewidth=1)
    g1 <- g1 + theme(axis.text.y = element_blank()) +
      theme(plot.margin = margin(t=5.5, r=1, b=5.5, l=1, unit="pt"))
    ylabs <- NULL
  }
  v <- e_mean2[[deparse(substitute(var))]] ## ugh
  g1 +
    scale_y_continuous(breaks=e_mean2$mid, labels=ylabs,
                       limits=c(min(e_mean2$prev_area) - inter, max(e_mean2$tot_area+inter))) +
    scale_x_continuous(limits=c(0,max(v)*1.05), expand=c(0,0)) +
    labs(x=xlab, title= title) +
    theme(axis.title.y = element_blank()) +
    theme(plot.title = element_text(hjust = 0.5))
}
cols <- c("darkolivegreen3", "orangered", "grey80", "grey60", "grey40")
plot_list <- list(
    mkplot(NPP_mean, cols[1], xlab=expression(g~C/m^{2}/year), title="NPP"),
    mkplot(Feat_mean, cols[2], type = "point", xlab="% of NPP", title = "Fire consumption"),
    mkplot(mbirds, cols[4], type = "point", xlab=expression(species/(10~km^{2})), title="Bird\nrichness"),
    mkplot(mmamm, cols[5], type = "point", xlab=expression(species/(10~km^{2})), title="Mammal\nrichness"),
    mkplot(mamph, cols[3], type = "point", xlab=expression(species/(10~km^{2})), title="Amphibian\nrichness")
)
```

```{r plot_fig2, fig.width=14, fig.height=8}
## give NPP a little extra space
wrap_plots(plot_list, nrow=1, widths=c(1.2, rep(1,4)))
ggsave("fig2.pdf",width=14, height=8)
```

Same thing but as boxplots (sorted by latitude??)
```{r plot_fig2box, fig.width=14, fig.height=5.5}
biome_latlon <- (ecoreg
    |> group_by(biome)
    |> summarise(lon = mean(x), lat = mean(y))
)
e2 <- (ecoreg
    |> mutate(across(biome, forcats::fct_reorder,
                     .x = y))
)
mkbplot <- function(var, colour, leftmost = FALSE, xlab = "", title= "") {
  g1 <- ggplot(e2)
  g1 <- g1 + geom_boxplot(aes(x={{var}}, y = biome), fill = colour)
  if (leftmost) {
      g1 <- g1 + theme(plot.margin = margin(t=5.5, r=1, b=5.5, l=50, unit="pt"))
  } else {
      g1 <- g1 + theme(axis.text.y = element_blank()) +
          theme(plot.margin = margin(t=5.5, r=1, b=5.5, l=1, unit="pt"),
                axis.text.y = element_blank())
  }
  g1  + labs(x=xlab, title= title) +
      theme(axis.title.y = element_blank()) +
      theme(plot.title = element_text(hjust = 0.5))
}
plot_list <- list(
    mkbplot(NPP_mean, cols[1], leftmost = TRUE, xlab=expression(g~C/m^{2}/year), title="NPP"),
    mkbplot(Feat_mean, cols[2], xlab="% of NPP", title = "Fire consumption"),
    mkbplot(mbirds, cols[4], xlab=expression(species/(10~km^{2})), title="Bird\nrichness"),
    mkbplot(mmamm, cols[5], xlab=expression(species/(10~km^{2})), title="Mammal\nrichness"),
    mkbplot(mamph, cols[3], xlab=expression(species/(10~km^{2})), title="Amphibian\nrichness")
)
wrap_plots(plot_list, nrow=1, widths=c(1.2, rep(1,4)))
ggsave("fig2X.pdf",width=14, height=5.5)
```

Table of values:

```{r fig2_tab, results = "asis"}
## newlines in headers screws up kable()
(e_mean2
  %>% left_join(fbdat, by = "biome")  ## add fraction-burned
  ## select/reorder columns (esp taxa)
  %>% dplyr::select(biome, bshort, area_km2, NPP_mean, Feat_mean, fracburn, mbirds, mmamm, mamph)
  %>% mutate(across(fracburn, ~.* 100))
  ## reverse order - now top to bottom
  %>% mutate(across(bshort, ~factor(.,levels=rev(levels(.)))))
  %>% arrange(bshort)
  %>% rename(biome=biome,
             abbrev=bshort,
             `area (10^6 km^2)` = area_km2,
             "NPP (g C/m^2/yr)" = NPP_mean,
             "Fire consumption"=Feat_mean,
             "Area burned (%)"=fracburn,
             "Bird richness (/10 km^2)" = mbirds,
             "Mammal richness (/10 km^2)" = mmamm,
             "Amphibian richness (/10 km^2)" = mamph)
  %>% knitr::kable(digits=2)
)
```

```{r tab1, results = "asis"}
trans_name <- function(x) {
  x <- tolower(x)
  x <- gsub("temp.", "temperate", x, fixed=TRUE)
  x <- gsub("trop.", "tropical", x, fixed = TRUE)
  x <- gsub("medit.", "mediterranean", x, fixed = TRUE)
  x <- paste0(toupper(substr(x,1,1)), substr(x, 2, nchar(x)))
  return(x)
}
  
fc_tab <- (e_mean2
  %>% left_join(fbdat, by = "biome")  ## add fraction-burned
  %>% left_join(biome_defs, c("biome" = "abbrev"))
  %>% dplyr::select(bshort, name, Feat_mean, fracburn, NPP_mean, area_km2)
  %>% mutate(bshort = reorder(factor(bshort), NPP_mean),
             area_frac = area_km2/sum(area_km2),
             small = area_frac<0.01
             )
  %>% transmute(
          biome = bshort,
          full = trans_name(name),
          `FC (yrs)` = 1/fracburn,
          `FCC (yrs)` = 1/(Feat_mean/100),
          small)
  %>% arrange(desc(biome))
  %>% mutate(across(biome, as.character))
  %>% mutate(across(biome, ~ifelse(small, paste0(.," *"), .)))
  %>% dplyr::select(-small)
)
knitr::kable(fc_tab, digits =1)
```

## Model results

### Figure 3

**(a)** Partial $R^2$ values of all model predictors for each taxa.
**(b)** Coefficient plot.
```{r model_coefs, warning = FALSE}
# Model coefficients' plot from Ben (MixedEfefcts.Rmd from 20200219)
# adding best_models[1:3] selection to avoid plotting model results for plants
L <- load("calc_rsq.rda")
std_order <- c("Area","NPP","NPP CV","Fire","Fire CV")
## create interaction terms
oo <- outer(std_order[-1],std_order[-1],paste,sep=":")
std_order2 <- c(std_order,oo[upper.tri(oo)]) ## append interactions to main effects
## NOT idempotent
mod_rsq <- (.
  %>% filter(taxon != "plants_log")  ## snuck in
  %>% mutate(across(taxon, factor,
             ## FIXME: cross-check order with coeff plot
             levels = c("mbirds_log","mmamm_log",  "mamph_log"),
             labels = c("Birds", "Mammals", "Amphibians")))
  %>% mutate(across(Effect, factor,
                    ## reverse order for top-to-bottom
                    levels = rev(c("Model", "all_fire", "all_NPP", std_order2)),
                    labels = rev(c("Model", "NPP (all)", "Fire (all)",
                               std_order2)))
             )
)
all_rsq_gamm4_sgv_2 <- mod_rsq(all_rsq_gamm4_sgv)
all_rsq_gamm4_kr_2 <- mod_rsq(all_rsq_gamm4_kr)

break_range <- c(0.32, 0.5)
vals <- unlist(all_rsq_gamm4_sgv_2[c("Rsq","upper.CL", "lower.CL")])
stopifnot(vals < break_range[1] | vals > break_range[2])  ## make sure breaks are OK

rsq_break_vals <- all_rsq_gamm4_sgv_2 %>% mutate(panel = Rsq > break_range[2])

  ## mutate(across(where(is.numeric),
  ##               ~ ifelse(. < break_range[1],
  ##                        .,
  ##                        . - break_range[2]))

rsqplot_plain <- ggplot(all_rsq_gamm4_sgv_2,
                  aes(Rsq, Effect, colour=taxon, shape=taxon))+
  geom_pointrangeh(aes(xmin=lower.CL,xmax=upper.CL),
                   position=position_dodgev(height=-0.7))+
  scale_colour_brewer(palette="Dark2")+
    ## scale_x_log10(limits=c(1e-2,1),oob=scales::squish)+
  labs(y="", x = expression(R^2)) +
    ## facet_grid(. ~ panel, scales ="free_x", space = "free_x") +
    scale_x_continuous(breaks=seq(0,0.7, by = 0.1)) +
    theme(legend.position = c(0.7,0.5),
          strip.text = element_blank())


## TRY AN AXIS BREAK (maybe a terrible idea)
rsqplot <- ggplot(rsq_break_vals,
                  aes(Rsq, Effect, colour=taxon, shape=taxon))+
  geom_pointrangeh(aes(xmin=lower.CL,xmax=upper.CL),
                   position=position_dodgev(height=-0.7))+
  scale_colour_brewer(palette="Dark2")+
    ## scale_x_log10(limits=c(1e-2,1),oob=scales::squish)+
  labs(y="", x = expression(R^2)) +
  facet_grid(. ~ panel, scales ="free_x", space = "free_x") +
  scale_x_continuous(breaks=seq(0,0.7, by = 0.1)) +
  theme(legend.position = c(0.7,0.5),
        strip.text = element_blank())

## Draw an explicit axis break?

## print(rsqplot)

## Two panels plot
## all_rsq$upper <- with(all_rsq,Effect %in% c("Model","NPP_log_sc","log(area_km2)"))
## r1 <- rsqplot %+% subset(all_rsq,upper)z`
## r2 <- rsqplot %+% subset(all_rsq,!upper)
## ## facet_wrap doesn't have 'space' argument ...
## ## rsqplot %+% all_rsq +facet_wrap(~upper,ncol=1,scales="free")
## ## facet_grid doesn't use axes for all facets ...
## ## rsqplot %+% all_rsq +facet_grid(upper~.,scales="free",space="free") +
## ##    theme(strip.text=element_blank())
## ## https://cran.r-project.org/web/packages/cowplot/vignettes/shared_legends.html
## L <- get_legend(r1)
## ## stack facets
## p1 <- plot_grid(r1 + xlim(0,0.75)  #W adding manual xlim to set the min value to 0
##                 +labs(x="")
##                 ## rectangle indicating scale of lower box w/in upper
##                 + geom_rect(xmin=0,xmax=0.125,ymin=-Inf,ymax=Inf,
##                             fill="black",
##                             colour=NA,alpha=0.02)
##                 + theme(legend.position="none"),
##                 r2+theme(legend.position="none")+xlab(expression("R" ^2)),  # adding expression to set R^2 in xlabels
##                 ncol=1,
##                 align="v",rel_heights=c(0.3,0.7),axis="b")

## Original Rsq plot + add legend
# plot_grid(p1,L,rel_widths=c(2,0.4))

## coefficient plot
coefs <- (best_models
  %>% purrr::map_dfr(tidy,effects="fixed", .id="taxon",
                     conf.int=TRUE)
  %>% filter(taxon != "plants_log")
  ## n.b. these are Wald intervals, might need to go back to gamm4_res
  ##  if we want profile CIs
  %>% mutate(term_orig = term)
  %>% mutate(across(term, ~ trans_labs(as.character(.))))
  %>% mutate(term=reorder(term,estimate))
  %>% rename(lwr="conf.low", upr="conf.high")
  %>% mutate(sig=(lwr*upr)>0)
  %>% filter(term!="(Intercept)")
  %>% mutate(across(taxon, factor,
             levels = c("mbirds_log","mmamm_log",  "mamph_log"),
             labels = c("Birds", "Mammals", "Amphibians")))
)

rescale_fun <- function(x, name) {
    ss <- strsplit(name,":")[[1]]
    for (s in ss) {
        sc <- attr(ecoreg[[s]],"scaled:scale") ## sd of original variable
        if (is.null(sc)) stop("uh-oh, ",s," has no scale")
        x <- x*sc
    }
    return(x)
}

coefs_rescaled <- coefs
for (v in c("estimate","lwr","upr")) {
    coefs_rescaled[[v]] <-
        purrr::map2_dbl(coefs_rescaled[[v]], coefs$term_orig, rescale_fun)
}

## fix reordering of interaction
coefs_rescaled <- (coefs_rescaled
  %>% mutate(across(term, ~ replace_value_chr(., "Fire:NPP CV","NPP CV:Fire")))
  %>% mutate(across(term, factor, levels = rev(std_order2)))
)

p2 <- ggplot(coefs_rescaled, aes(estimate,term,colour=sig))+
  geom_linerangeh(aes(xmin=lwr,xmax=upr))+
  geom_point(fill="white")+
  geom_vline(xintercept=0,lty=2)+
  facet_wrap(~taxon, nrow=1)+
  labs(x="Log-log regression coefficients (elasticities)", y="")+
  scale_colour_manual(values=c("black","orange"),guide="none") +
  zmargin 
  ## careful about squashing panels together (messes with tick labels);
  ## shrink y-axis tick labels (better now that x-scales are fixed)
  ## if being really fussy, add a phantom point with Mammals/x =-0.15 to expand range slightly
## theme(axis.text.x = element_text(size=9))


## Combined Rsq + coefficient plot
## plot_grid(p1,L,p2,rel_widths=c(2,0.4,2),rel_heights=c(2,1.5),labels=c('(a)','','(b)'))
plot_grid(rsqplot,p2, labels=c('(a)','(b)'), ncol= 1)
ggsave("fig3.pdf", width=8, height = 6)
```

Alternative:

```{r new_rsqplot}
plot_grid(rsqplot_plain,p2, labels=c('(a)','(b)'), ncol= 1)
ggsave("fig3X.pdf", width=8, height = 6)
```

## Fig 3a: table of values
```{r est_rsq_tab,results="asis",echo=FALSE}
(all_rsq_gamm4_sgv_2
    ## reverse order - now top to bottom
    %>% mutate(across(Effect, ~factor(.,levels=rev(levels(.)))))
    %>% dplyr::select(taxon,term=Effect,estimate=Rsq,lwr=lower.CL,upr=upper.CL)
    %>% arrange(term,taxon)
    %>% mutate(est=sprintf("%1.2g (%1.2g, %1.2g)",estimate,lwr,upr))
    %>% dplyr::select(taxon, term, est)
    %>% pivot_wider(names_from=taxon,values_from=est)
    %>% knitr::kable()
)
```

<!-- ## proportions -->

```{r prop_table, results = "asis", eval=FALSE, echo = FALSE}
mk_proptab <- (.
  %>% filter(Effect %in% c("Model", "NPP (all)", "Fire (all)", "Area"))
  %>% dplyr::select(taxon, Effect, Rsq)
  %>% group_by(taxon)
  %>% mutate(Model_rsq = Rsq[Effect == "Model"])
  %>% filter(Effect != "Model")
  %>% mutate(prop = Rsq/Model_rsq)
  %>% dplyr::select(-Rsq)
  %>% pivot_wider(names_from = "Effect", values_from = "prop", id_cols=c(taxon,Model_rsq))
  %>% arrange(taxon)
)
knitr::kable(mk_proptab(all_rsq_gamm4_sgv_2), digits = 3)
```

```{r other_prop_table, eval=FALSE}
## K-R gives very weird/unrealistic results, probably because of low model R^2 values??
knitr::kable(mk_proptab(all_rsq_gamm4_kr_2), digits = 3)
```

## Fig 3b: table of values
```{r est_tab,results="asis",echo=FALSE}
(coefs_rescaled
    ## reverse order - now top to bottom
    %>% mutate(across(term, ~factor(.,levels=rev(levels(.)))))
    %>% dplyr::select(taxon,term,estimate,lwr,upr)
    %>% arrange(term,taxon)
    %>% mutate(est=sprintf("%1.2g (%1.2g, %1.2g)",estimate,lwr,upr))
    %>% dplyr::select(taxon, term, est)
    %>% pivot_wider(names_from=taxon,values_from=est)
    %>% knitr::kable()
)
```

```{r plots_ori_vars,warning=FALSE,echo=FALSE}
### Plots of the original variables
taxon_names <- c("mbirds","mamph","mmamm")
respvars <- paste0(taxon_names,"_log")
predvars <- c("NPP_log_sc","Feat_log_sc","NPP_cv_sc","Feat_cv_sc","area_km2_log_sc")
## plot raw values of diversity for a given taxon/predictor
## generate all combinations
orig_plots <- list()
for (i in seq_along(taxon_names)) {
    orig_plots[[taxon_names[i]]] <- list()
    for (pp in predvars) {
      orig_plots[[taxon_names[i]]][[pp]] <-
        plotfun(model=NULL,respvar=respvars[i],
                xvar=pp,data=ecoreg,
                backtrans=TRUE,log="xy")+
                theme(legend.position="none")
    }
}
orig_plots_nolog <- list()
for (i in seq_along(taxon_names)) {
    orig_plots_nolog[[taxon_names[i]]] <- list()
    for (pp in predvars) {
      orig_plots_nolog[[taxon_names[i]]][[pp]] <-
        plotfun(model=NULL,respvar=respvars[i],
                xvar=pp,data=ecoreg,
                backtrans=TRUE) + # ,log="xy")+
                theme(legend.position="none")
    }
}


#### Computing and plotting partial residuals
sc_taxon_names <- paste(c("Birds","Mammals","Amphibians"),
                      "N sp/km2")
names(sc_taxon_names) <- paste0(c("mbirds","mmamm","mamph"),"_log")
sc_pred_names <- c(NPP_log_sc="log NPP g*C/m2*year",
                   Feat_log_sc="log Feat (% of NPP)",
                   NPP_cv_sc="scaled CV of NPP",
                   Feat_cv_sc = "scaled CV of Feat")

taxon_names <- paste(c("Birds","Mammals","Amphibians"),"(species/km^2)",sep="~")
names(taxon_names) <- paste0(c("mbirds","mmamm","mamph"),"_log")
pred_names <- c(NPP_log_sc="NPP~(g*C %.% m^{-2} %.% year^{-1})",
                NPP_cv_sc="Interannual~CV~of~NPP",
                area_km2_log_sc="Ecoregion~area~(km^{-2})",
                Feat_log_sc="Fire~consumption~('%'*NPP)",
                Feat_cv_sc = "Interannual~CV~of~fire~consumption")


replace_names <- (.
  %>% mutate(across(taxon, ~factor(., levels = names(taxon_names), labels = taxon_names)))
  %>% mutate(across(predvar, ~factor(., levels = names(pred_names), labels = pred_names)))
)

remef_vars <- list()
for (tt in setdiff(names(best_models), "plants_log")) {
  for (predvar in c("NPP_log_sc", "NPP_cv_sc", "area_km2_log_sc", "Feat_log_sc", "Feat_cv_sc")) {
    pp <- plotfun(model = best_models[[tt]],
                  xvar = predvar, respvar = "partial_res",
                  auxvar = NULL, return_data = TRUE, backtrans = TRUE)
    pp$data[["taxon"]] <- pp$pdata[["taxon"]] <- tt
    pp$data[["predvar"]] <- pp$pdata[["predvar"]] <- predvar
    remef_vars <- c(remef_vars, list(pp))
  }
}
plotdata <- (purrr::map_dfr(remef_vars, ~ .[["data"]])
  %>% replace_names()
  %>% full_join(shortnames, by = "biome")
  ## highest to lowest NPP
  %>% mutate(across(bshort, ~ reorder(factor(.), -NPP_mean)))
)

preddata <- purrr::map_dfr(remef_vars, ~ .[["pdata"]]) %>% replace_names()

minobs <- (plotdata
  %>% group_by(taxon)
  %>% summarise(minval = min(richness, na.rm = TRUE), .groups = "drop")
)

preddata <- (preddata
    %>% full_join(minobs, by = "taxon")
    %>% group_by(taxon)
    %>% mutate(across(lwr, ~ ifelse(. < min(minval, min(richness)),
                                    min(minval, min(richness)),
                                    .)))
)

## preddata %>% group_by(taxon) %>% summarise(minlwr = min(lwr[is.finite(lwr)]))

library(colorspace)
nbiome <- length(levels(droplevels(ecoreg$biome)))
oo <- c(t(matrix(seq(nbiome), ncol=2)))
qq <- c(qualitative_hcl(n = nbiome/2, l = 30),
       qualitative_hcl(n = nbiome/2, l = 70))
paired_qual <- scale_colour_manual(values = qq[oo], name = "biome")

do_plot <- function(plotdata, preddata, interax = FALSE, qvec = c(0.1, 0.5, 0.9)) {
    gg0 <- (ggplot(plotdata, aes(focal, richness, colour = bshort))
        + geom_point(aes(shape = flor_realms))
        )
    if (!interax) {
        gg0 <- (gg0 
            + geom_line(data = preddata, colour = "black")
            + geom_ribbon(data = preddata, colour = NA,
                          fill = "black", alpha = 0.3,
                          aes(ymin = lwr, ymax = upr)) +
            facet_grid(taxon ~ predvar, scale="free", labeller= label_parsed,
                       switch = "both")
        )
    } else {
        gg0 <- (gg0 + geom_line(data = preddata, colour = "black",
                        aes(linetype = auxvarQ))
            + geom_ribbon(data = preddata, colour = NA,
                          fill = "black",
                          alpha = 0.15,
                          aes(ymin = lwr, ymax = upr, group = auxvarQ))
            + scale_linetype(name = "aux var\nquantile",
                             breaks = sprintf("Q(%1.1f)", qvec),
                             labels = qvec)
            + facet_grid(taxon ~ predvar+auxvar,
                       scale="free", labeller= label_parsed,
                       switch = "both")
        )
    }
    ## switch/strip.placement
    ## https://github.com/tidyverse/ggplot2/issues/1231
    gg0 +
        theme(strip.placement = "outside", strip.background = element_blank()) +
        scale_x_log10(labels = scientific_10) +
        labs (x = "", y = "") +
        scale_y_log10() +
        zmargin  +
        paired_qual +
        ## scale_colour_discrete_qualitative(name = "biome") +
        scale_shape(name = "floristic realm")
}


add_corner_labels <- function(p, type = "lowercase", size = 6,
                              hjust = -0.5, vjust = 1.25) {
    bb <- ggplot_build(p)
    dd <- bb$layout$layout
    dd$labs <- switch(type, lowercase = letters[seq(nrow(dd))])
    p + geom_text(data = dd, x = -Inf, y = Inf, colour = "black", aes(label = labs),
                  hjust = hjust, vjust = vjust, size = size)
}

fig4 <- do_plot(
    filter(plotdata, predvar %in% pred_names[1:3]),
    filter(preddata, predvar %in% pred_names[1:3])) %>%
    add_corner_labels()
fig5 <- do_plot(
    filter(plotdata, predvar %in% pred_names[4:5]),
    filter(preddata, predvar %in% pred_names[4:5])) %>%
    add_corner_labels()
```

```{r colors, fig.width = 20, fig.height = 20, warning=FALSE, message=FALSE, eval= FALSE}
## playing with colour choices
## go from "forest green" to "tan": need beginning/ending HCL values
## hcl.color.picker
##   (150, 48, 52) -> (60,63,70)
## colours in opposite order from legend
green_to_tan <- scale_colour_discrete_sequential(h1 = 150, h2=60, c1=48, c2=63, l1=52, l2=70, rev=FALSE)
scrambled_qual <- scale_colour_manual(values = qualitative_hcl(n = nbiome)[oo])
                                         

noleg <- theme(legend.position = "none")
## fig4 + scrambled_qual  + ggtitle("colorspace qual, scrambled")
## fig4 + paired_qual  + ggtitle("colorspace qual, paired")

plot_grid(
    fig4 + scale_colour_discrete_qualitative() + noleg + ggtitle("colorspace, qualitative"),
    fig4 + scrambled_qual + noleg + ggtitle("colorspace qual, scrambled"),
    fig4 + scale_colour_viridis_d()  + noleg + ggtitle("viridis"),
    fig4 + scale_colour_manual(values = topo.colors(length(levels(plotdata$bshort))))  + noleg  + ggtitle("topo colors"),
    fig4 + green_to_tan  + noleg  + ggtitle("custom green-to-tan"),
    fig4 + paired_qual + noleg + ggtitle("colorspace qual, paired")
    ## fig4 + hues::scale_colour_iwanthue() + noleg  + ggtitle("maximal distinction"))
)
```    



```{r resids_plots}
## partial residuals plots
remef_plot <- function(taxon="mbirds_log",xvar="NPP_log",
                       auxvar=NULL,title=NULL) {
    m <- best_models[[taxon]]
    if (is.null(title)) {
        title <- if (is.null(auxvar)) xvar else {
             paste(xvar,auxvar,sep=":")                                     
                                              }
    }
    pp <- (plotfun(m,xvar=xvar,respvar="partial_res",
                   auxvar=auxvar,data=ecoreg,
                   backtrans=TRUE,log="xy") 
      + theme(legend.position="none")
      + ggtitle(title)
    )
    return(pp)
}
remef_plot_nolog <- function(taxon="mbirds_log",xvar="NPP_log",
                       auxvar=NULL,title=NULL) {
    m <- best_models[[taxon]]
    if (is.null(title)) {
        title <- if (is.null(auxvar)) xvar else {
             paste(xvar,auxvar,sep=":")                                     
                                              }
    }
    pp <- (plotfun(m, xvar=xvar, respvar="partial_res",
                   auxvar=auxvar, data=ecoreg,
                   backtrans=TRUE) #,log="xy"
      + theme(legend.position="none")
      + ggtitle(title)
    )
    return(pp)
}
## rp1: NPP_log
## rp2: NPP_log:Feat_cv_sc
## rp3: NPP_log:Feat_log
## rp4: Feat_log:NPP_cv_sc
## rp5: Feat_log
## rp6: NPP_cv_sc
## rp7: Feat_cv_sc
rem_predvars <- list("NPP_log_sc",
                     "NPP_log_sc",
                     "NPP_log_sc",
                     "Feat_log_sc",
                     "Feat_log_sc",
                     "NPP_cv_sc",
                     "Feat_cv_sc",
                     "area_km2_log_sc")
rem_auxvars <- list(NULL,"Feat_cv_sc","Feat_log_sc",
                    "NPP_cv_sc",NULL,NULL,NULL,NULL)
## construct all combinations of partial residuals for each taxon
remef_plots <- list()
for (tt in names(sc_taxon_names)) { ## for each taxon
    remef_plots[[tt]] <- list()
    for (pp in seq_along(rem_predvars)) { ## for each predictor variable
      ## cat(tt,pp,"\n")
      ## cat(tt," ",pp,"\n")
      ## generate and save the partial residuals plot
      remef_plots[[tt]][[pp]] <- remef_plot(tt,xvar=rem_predvars[[pp]],
                                            auxvar=rem_auxvars[[pp]])
      ## print(remef_plots[[tt]][[pp]])
    }
}
remef_plots_nolog <- list()
for (tt in names(sc_taxon_names)) { ## for each taxon
    remef_plots_nolog[[tt]] <- list()
    for (pp in seq_along(rem_predvars)) { ## for each predictor variable
      ## cat(tt,pp,"\n")
      ## cat(tt," ",pp,"\n")
      ## generate and save the partial residuals plot
      remef_plots_nolog[[tt]][[pp]] <- remef_plot_nolog(tt,xvar=rem_predvars[[pp]],
                                            auxvar=rem_auxvars[[pp]])
      ## print(remef_plots[[tt]][[pp]])
    }
}
```

## Figure 4

```{r fig4, fig.width = 8, fig.height = 8, warning = FALSE}
print(fig4)
ggsave(plot = fig4, file = "fig4.pdf", width = 8, height = 8)
```

## Figure 5

```{r fig5, fig.width = 8, fig.height = 8, warning = FALSE}
print(fig5)
ggsave(plot = fig5, file = "fig5.pdf", width = 6.5, height = 8)
```
## interactions (supp)

## biome effects (supp)

```{r predfun_biome_construct}
allfits_restr_gamm4 <- readRDS("allfits_restr_gamm4.rds")
predList <- lapply(allfits_restr_gamm4[1:3], ## skip plants
       predfun,
       auxvar=NULL,
       grpvar="biome",
       re.form=~(1+NPP_log_sc|biome))
set.focal <- function(n,d) { d$focal <- d[[n]]; return(d) }
predList <- Map(set.focal, names(predList), predList)
predFrame <- bind_rows(predList,.id="taxon")
## make copies of ecoreg for each panel (ugh?)
dList <- setNames(replicate(3,ecoreg,simplify=FALSE), names(predList))
dList <- Map(set.focal, names(dList), dList)
dFrame <- bind_rows(dList,.id="taxon")
```

```{r make_pretty}
make_pretty <- (.
    %>% mutate(across(taxon, factor, 
                      levels = c("mbirds_log", "mmamm_log", "mamph_log"),
                      labels = c("Birds", "Mammals", "Amphibians")))
    %>% mutate(across(focal, exp))
    ## unscale/unlog NPP variable
    %>% backtrans_var("NPP_log_sc", otherdata = ecoreg)
    %>% backtrans_var("Feat_log_sc", otherdata = ecoreg)
    %>% left_join(shortnames, by = "biome")
    %>% mutate(biome = reorder(bshort, -NPP))
)
```

```{r predfun_biome_plot,warning=FALSE,fig.width=10,fig.height=5}
fig3a_supp <- ggplot(make_pretty(predFrame),
       aes(x=NPP, y=focal, colour=biome)) +
    geom_line(lwd=1.5)+
    geom_point(data=make_pretty(dFrame),
               aes(shape=flor_realms), alpha=0.7) +
    facet_wrap(~taxon) +
    zmargin +
    labs(y="richness") +
    scale_x_log10() + scale_y_log10() +
    theme(legend.position="bottom") +
    scale_shape(name = "floristic realm") +
    paired_qual

print(fig3a_supp)
ggsave(file="fig3a_supp.pdf", width=10, height=5)
```

```{r predList_fire}
predList_fire <- lapply(allfits_restr_gamm4[1:3],
       predfun,
       xvar="Feat_log_sc",
       auxvar=NULL,
       grpvar="biome",
       re.form=~(1+Feat_log_sc|biome))
predList_fire <- Map(set.focal, names(predList_fire), predList_fire)
predFrame_fire <- bind_rows(predList_fire,.id="taxon")
fire_slopes <- predList_fire %>% bind_rows(.id = "taxon") %>%
    dplyr::select(taxon, biome, focal, Feat_log_sc) %>%
    group_by(taxon, biome) %>%
    summarise(focal_range = diff(range(focal)),
              x_range = diff(range(Feat_log_sc)),
              slope = focal_range/x_range, .groups = "drop")
NPP_slopes <- predList %>% bind_rows(.id = "taxon") %>%
   dplyr::select(taxon, biome, focal, NPP_log_sc) %>%
    group_by(taxon, biome) %>%
    summarise(focal_range = diff(range(focal)),
              x_range = diff(range(NPP_log_sc)),
              slope = focal_range/x_range, .groups = "drop")
slopes <- bind_rows(list(Feat_log_sc=fire_slopes, NPP_log_sc=NPP_slopes),
                    .id = "term")
```

```{r predfun_biome_plot_fire,warning=FALSE,fig.width=10,fig.height=5}
fig3b_supp <- ggplot(make_pretty(predFrame_fire),
       aes(x=Feat, y=focal, colour=biome)) +
    geom_line(lwd=1.5)+
    geom_point(data=make_pretty(dFrame),
               aes(shape=flor_realms), alpha=0.7) +
    facet_wrap(~taxon) +
    zmargin +
    labs(y="richness", x="Fire consumption") +
    scale_x_log10(labels = scientific_10) + scale_y_log10() +
    theme(legend.position="bottom") +
    paired_qual +
    scale_shape(name = "floristic realm")

print(fig3b_supp)
ggsave(file="fig3b_supp.pdf", width=10, height=5)
```

## plot slopes (checking)

black dots are slopes based on the random effects (but with global values for the auxiliary variables); blue dots incorporate biome-specific values of the auxiliary variables

```{r caterpillars}
library(lme4)
all_ranef <- purrr::map_dfr(allfits_restr_gamm4[1:3],
                            ~(tidy(., effects = "ran_vals")
                                %>% filter(group == "biome",
                                           term %in% c("Feat_log_sc", "NPP_log_sc"))
                                %>% dplyr::select(level, term, estimate, std.error)
                                %>% rename(biome = "level")),
                            .id = "taxon")

bird_NPP_lev <- all_ranef %>% filter(taxon == "mbirds_log", term == "NPP_log_sc") %>%
    arrange(estimate) %>% pull(biome)


fe <- purrr::map_dfr(allfits_restr_gamm4[1:3],
                     ~(tidy(., effects = "fixed") %>%
                       filter(term %in% c("Feat_log_sc", "NPP_log_sc"))),
                     .id = "taxon"
                     ) %>% dplyr::select(taxon, term, estimate,std.error)

all_coef <-
    full_join(all_ranef, fe, by = c("taxon", "term")) %>%
    mutate(across(biome, ~ factor(., levels = bird_NPP_lev))) %>%
    transmute(taxon, biome, term, estimate = estimate.x + estimate.y,
              std.error = sqrt(std.error.x^2 + std.error.y^2))

biome_coef <- ggplot(all_coef, aes(x=estimate, y = biome )) +
    geom_pointrange(aes(xmin = estimate-2*std.error,
                        xmax = estimate + 2*std.error)) + 
    geom_point(data=slopes, colour = "blue", aes(x=slope)) + 
    facet_grid(taxon ~ term, scale = "free_x") +
    zmargin +
    labs(y="", x="pop slope (scaled)") +
    geom_vline(xintercept = 0, colour = "red", lty = 2)
print(biome_coef)
ggsave("fig_biome_coef.pdf", width = 8, height = 12)
```

## interaction plots

Interactions with NPP: NPP $\times$ {Fire cons, NPP_cv,  Fire cons CV}

Interactions with Fire: Fire $\times$ {NPP_cv, Fire_cv}; NPP cv $\times$ Fire cv

```{r interax_calc}
vardf <- (tidy(best_models[[1]], effects="fixed")
    %>% pull(term)
    %>% grep(pattern = ":", value=TRUE)
    %>% strsplit(":")
    %>% do.call(what="rbind")
    %>% as.data.frame()
    %>% setNames(c("xvar", "auxvar"))
)
       
remef2_vars <- list()
for (tt in setdiff(names(best_models), "plants_log")) {
    for (i in seq(nrow(vardf))) {
        xvar <- vardf$xvar[[i]]
        auxvar <- vardf$auxvar[[i]]
        pp <- plotfun(model = best_models[[tt]],
                  xvar = xvar,
                  respvar = "partial_res",
                  auxvar = auxvar,
                  return_data = TRUE,
                  backtrans = TRUE)
        pp$data[["taxon"]] <- pp$pdata[["taxon"]] <- tt
        pp$data[["predvar"]] <- pp$pdata[["predvar"]] <- xvar
        pp$data[["auxvar"]] <- pp$pdata[["auxvar"]] <- auxvar
        pp$pdata[["auxvarQ"]] <- pp$pdata[[paste0("f",auxvar)]]
        remef2_vars <- c(remef2_vars, list(pp))
    }
}

auxnames <- paste0("aux:~", c("Fire~cons",
                              "NPP~CV",
                              "Fire~cons~CV"))
names(auxnames) <- c("Feat_log_sc", "NPP_cv_sc", "Feat_cv_sc")

replace_auxvar <- (.
    %>% mutate(across(auxvar, ~factor(., levels = names(auxnames), labels = auxnames)))
)

plotdata2 <- (purrr::map_dfr(remef2_vars, ~ .[["data"]])
    %>% replace_names() %>% replace_auxvar()
    %>% full_join(shortnames, by = "biome")
    ## highest to lowest NPP
    %>% mutate(across(bshort, ~ reorder(factor(.), -NPP_mean)))
)

preddata2 <- purrr::map_dfr(remef2_vars, ~ .[["pdata"]]) %>% replace_names() %>% replace_auxvar()

minobs <- (plotdata2
    %>% group_by(taxon)
    %>% summarise(minval = min(richness, na.rm = TRUE), .groups = "drop")
)

## not idempotent!
preddata2 <- (preddata2
    %>% full_join(minobs, by = "taxon")
    %>% group_by(taxon)
    %>% mutate(across(lwr, ~ ifelse(. < min(minval, min(richness)),
                                    min(minval, min(richness)),
                                    .)))
)

interax_plot <- do_plot(plotdata2, preddata2, interax=TRUE) %>% add_corner_labels()
```

```{r print_interax, fig.width=20, fig.height=12, warning = FALSE}
print(interax_plot)
ggsave("fig_interax_supp.pdf", width = 20, height = 12)
```

**to do**: split into two plots?

```{r coefs}
gamm4_res <- readRDS("allfits_sum_gamm4.rds") ## 4 taxa x 27 fits, using gamm4
ex <- "mamm_log"
mk_robplot <- function(ex, ex_title = NULL, drop_legend = FALSE, AIC_thresh = 10, label_size = 8) {

  ## only non-singular model for mammals has AIC=15, make sure to keep it ...
  gamm4_allcoef <- (get_allcoefs(gamm4_res, focal_taxon = ex)
    %>% mutate(lwr = conf.low, upr = conf.high)
    %>% dplyr::select(-c(effect, group, taxon))
    ## order facets by variable R2/scaled magnitude; order models by AIC
    %>% mutate(mval = AIC + as.numeric(singular)*100,
               across(model, ~reorder(factor(.), -mval)),
               tval = abs(statistic),
               across(term, ~reorder(factor(.), -tval))
               )
    %>% arrange(term)
    %>% filter(AIC < AIC_thresh | !singular)
  )

  ## gamm4_allcoef %>% dplyr::select(model, singular, AIC, mval) %>% distinct() %>%
  ## mutate(mcode = as.numeric(model))
  
  gg_allcoef <- (ggplot(gamm4_allcoef,
                        aes(estimate, model, colour = singular, shape = singular))
    ## use point + linerange because some RE are missing std.errors
    + geom_point()
    + geom_linerangeh(aes(xmin=lwr, xmax=upr))
    + facet_wrap(~term, scale="free_x")
    + geom_vline(xintercept=0, lty=2)
    + scale_colour_brewer(palette="Set1")
    + theme(strip.text.x = element_text(size = label_size))
    + zmargin
  )

  if (drop_legend) gg_allcoef <- gg_allcoef + theme(legend.position = "none")
  

  if (!is.null(ex_title)) {
    gg_allcoef <- gg_allcoef + ggtitle(ex_title)
  }
  
  return(gg_allcoef)
}

robplots <- purrr::pmap(list(c("mamph_log", "mbirds_log", "mmamm_log"),
                             c("amphibians", "birds", "mammals"),
                             c(TRUE, TRUE, FALSE)),
                        mk_robplot
                        )
plot_grid(plotlist = robplots, nrow=1, rel_widths = c(0.85,0.85,1))
ggsave("fig_robust_supp.pdf", width = 20, height = 8)
```

Caption: robustness test of model variants. Models are denoted by the covariance structure (i = intercept-only; d = diagonal; f = full) used for each random effect (b = biome; fr = floral realm; b_FR = biome × floral realm interaction). They are ordered with non-singular models first; within singularity category they are ordered by AIC (thus, the best models are at the top within each panel). Only models with ΔAIC<10 are included. Parameters are ordered by average p-value (most significant terms at top left). Bars represent 95% confidence intervals
